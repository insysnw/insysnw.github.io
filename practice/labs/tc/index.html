<!DOCTYPE html>
<html lang="ru">
  <head>
    <link rel="stylesheet" href="/fonts/stylesheet.css" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Курс ТКС</title>
    <link
      rel="stylesheet"
      href="/insysnw.css"
    />
	<!--
	  Pins footer to the bottom
	  TODO: place it properly
	-->
    <style>
      .course {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      body {
        display: flex;
        min-height: 100vh;
        flex-direction: column;
      }

      footer {
        margin-top: auto;
      }
    </style>
  </head>

  <body>
    <div class="course">
      <header>
        <nav class="level nerd">
          <p class="level-item has-text-centered">
		    <a href="/lectures">
              <span class="icon">
                <i class="mdi mdi-24px mdi-book-open-page-variant" aria-hidden="true"></i>
              </span>
              <span class="f3270">Лекции</span>
            </a>
          </p>
          <p class="level-item has-text-centered">
		    <a href="/practice">
              <span class="icon">
                <i class="mdi mdi-24px mdi-flask" aria-hidden="true"></i>
              </span>
              <span class="f3270">Практика</span>
            </a>
          </p>
          <p class="level-item has-text-centered">
            <img
              src="https://icst.spbstu.ru/userfiles/files/Risunok-KSPT.png"
              alt="КСПТ"
              style="height: 50px"
            />
          </p>
          <p class="level-item has-text-centered">
		    <a href="/awesome">
              <span class="icon">
                <i class="mdi mdi-24px mdi-sunglasses" style="color: #fc60a8;" aria-hidden="true"></i>
              </span>
              <span class="f3270">Awesome</span>
            </a>
          </p>
          <p class="level-item has-text-centered">
		    <a href="/">
              <span class="icon">
                <i class="mdi mdi-24px mdi-information-outline" aria-hidden="true"></i>
              </span>
              <span class="f3270">О курсе</span>
            </a>
          </p>
        </nav>
      </header>
      <main>
        <section class="section">
          <div class="container">

<h1 class="title">
Лабораторная: Эмуляция неблагоприятный условий сети
<h1>

<div class="content">
<p>В этой лабораторной нас ждёт знакомство с утилитой <code>tc</code> (traffic control).
Она является частью пакета <code>iproute2</code> и представлена в большинстве дистрибутивов Linux.</p>
<p>Говорящее название утилиты не врёт.
А самый важный аспект управления трафиком для нас - эмуляция поведения сети.
Разрабатывая приложение локально, мы используем loopback интерфейс, а это почти самые идеальные условия из возможных.
Это позволяет легко забыть, как неблагоприятен реальный мир.
И разработать ПО, которое не будет в нём корректно функционировать.</p>
<p>Мобильный телефон посреди поля, далеко за пределами крупного города, вряд ли сможет найти 5G с максимальным уровнем сигнала.
Хорошо, если это будет сеть третьего поколения больше, чем с одной “палочкой”.
В такой ситуации страдает не только пропускная способность канала, но и количество потерь, целостность пакетов.</p>
<p>Как много клиентов будут пользоваться нашим приложением в таких условиях?
В полях нужно наслаждаться природой, а не в телефоне сидеть!
Трактор от John Deere или их конкурентов, может выступить в роли несогласного телефона, уверенного работающего в поле.</p>
<p>К сожалению, есть примеры плохих сетевых условий, куда более близкие к повседневной жизни.
Неудачно расставленные WiFi точки доступа в офисе и учебном кампусе.
Многоквартирные дома с “шумными” WiFi каналами.
Проводное подключение тоже не решение всех проблем.
Провод, неудачно проложенный рядом с силовой линией, может иметь количество потерь не совместимое с его работоспособностью.</p>
<p>Traffic control позволяет имитировать проблемы возникающие во всех вышеупомянутых условиях.
И ещё чуть-чуть.</p>
<h2 id="zaderzhka">Задержка</h2>
<p>Прежде, чем вносить изменения снимем исходные показания.</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">ping -c</span><span> 10 github.com
</span></code></pre>
<p>C большой вероятностью, обошлось без потерь пакетов, а значения задержки могут быть меньше одной миллисекунды.</p>
<p>Добавим константную задержку:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">tc</span><span> qdisc add dev eth0 root netem delay 200ms
</span></code></pre>
<p>К значениям задержки добавятся те самые 200 мс.
Если упражнение выполняется на удалённом сервере, то ощутимой должна стать и задержка при работе по ssh.
Ведь и это тоже сетевое взаимодействие, а мы только что добавили по 1/5 секунды на каждый вывод информации пользователю.</p>
<p>Вывод текущего состояния:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">tc</span><span> qdisc show  dev eth0
</span></code></pre>
<p>Очистка всех egress правил</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">tc</span><span> qdisc del dev eth0 root
</span></code></pre>
<p>Добавим правило с динамическим распределением задержки:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">tc</span><span> qdisc add dev eth0 root netem delay 50ms 5ms
</span></code></pre>
<p>Изменим имеющееся правило, добавив корреляцию (TODO: докинуть, кого и с кем и зачем)</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">tc</span><span> qdisc change dev eth0 root netem delay 50ms 5ms 25%
</span></code></pre>
<p>Также можно указать тип распределения (<code>normal</code>, <code>pareto</code> и <code>paretonormal</code>):</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">tc</span><span> qdisc change dev eth0 root netem delay 50ms 10ms distribution normal
</span></code></pre>
<h2 id="poteria-paketov">Потеря пакетов</h2>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">tc</span><span> qdisc add dev eth0 root netem loss 10%
</span></code></pre>
<h2 id="peremeshivanie-paketov">Перемешивание пакетов</h2>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">reorder
</span></code></pre>
<h2 id="povrezhdenie-paketov">Повреждение пакетов</h2>
<p>Имитируем изменение одного случайного бита:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">tc</span><span> qdisc change dev eth0 root netem corrupt 5%
</span></code></pre>
<h2 id="dyblikatsiia-paketa">Дyбликация пакета</h2>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">tc</span><span> qdisc change dev eth0 root netem duplicate 1%
</span></code></pre>
<h2 id="ogranichenie-propusknoi-sposobnosti">Ограничение пропускной способности</h2>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">tc</span><span> qdisc add dev eth0 root tbf rate 1mbit burst 32kbit latency 400ms
</span></code></pre>
<h1 id="extra">Extra</h1>
<p>Как губить не всю сеть - фильтры</p>

</div>
</div>
        </section>
      </main>

      <footer class="footer" style="margin-top: auto">
        <div class="content has-text-centered">
          <p>
            Сделяль <a href="https://ejiek.com">@ejiek</a>. Исходный код имеет
            лицензию
            <a href="http://opensource.org/licenses/mit-license.php">MIT</a>.
            Содержимое сайта имеет лицензию
            <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a
            >.
          </p>
        </div>
      </footer>
    </div>
  </body>
</html>
